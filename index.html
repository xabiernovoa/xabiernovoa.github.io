<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Quiz desde Excel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f7f7f7; margin: 0; padding: 0;}
    .quiz-container { background: #fff; max-width: 600px; margin: 2rem auto; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); padding: 2rem 1.5rem;}
    .question { font-size: 1.1rem; margin-bottom: 2rem; font-weight: bold;}
    .options { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem;}
    .option-btn { padding: 0.8rem 1rem; border: none; border-radius: 6px; background: #e7e7e7; font-size: 1rem; text-align: left; cursor: pointer; transition: background 0.2s, color 0.2s;}
    .option-btn.selected { border: 2px solid #007acc; background: #d0ebff;}
    .option-btn.correct { background: #4caf50 !important; color: #fff;}
    .option-btn.incorrect { background: #f44336 !important; color: #fff;}
    .nav-buttons { display: flex; justify-content: space-between; gap: 1rem; margin-bottom: 1rem;}
    .nav-btn { font-size: 1rem; padding: 0.6rem 1.4rem; border: none; border-radius: 6px; background: #007acc; color: #fff; cursor: pointer; transition: background 0.2s;}
    .nav-btn:disabled { background: #bbb; cursor: not-allowed;}
    .result { font-size: 1.3rem; font-weight: bold; text-align: center; margin-bottom: 1.2rem;}
    .restart-btn, #restartQuizBtn { display: block; margin: 1rem auto 0 auto; font-size: 1rem; padding: 0.7rem 1.6rem; border: none; border-radius: 6px; background: #2196f3; color: #fff; cursor: pointer;}
    #uploader { margin: 2rem auto 1rem auto; max-width:600px; display: flex; flex-direction:column; gap:1rem; align-items:center;}
    #uploader label { font-weight: bold;}
    #waitMsg {
      color: #444; background: #fff9c4; border: 1px solid #ffe082; border-radius: 6px; padding: 0.5rem 1rem; margin-top: 1rem; font-size: 1rem; text-align: center;
      display: none;
    }
    @media (max-width: 600px) {
      .quiz-container { padding: 1rem 0.5rem;}
      .question { font-size: 1rem;}
      .option-btn { font-size: 0.96rem;}
    }
  </style>
  <!-- SheetJS para leer Excel en el navegador -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div id="uploader">
    <label for="fileInput">Cargar archivo Excel (.xlsx) del quiz:</label>
    <input type="file" id="fileInput" accept=".xlsx,.xls" />
    <span id="uploadMsg"></span>
    <div id="waitMsg">Cargando archivo, por favor espera unos segundos hasta que aparezca el quiz...</div>
  </div>
  <div class="quiz-container" id="quizContainer" style="display:none"></div>
  <button id="restartQuizBtn" style="display:none;">Reiniciar quiz</button>
  <script>
    let questions = [];
    let current = 0;
    let selectedAnswers = [];
    let quizCompleted = false;

    document.getElementById('fileInput').addEventListener('change', handleFile, false);
    document.getElementById('restartQuizBtn').addEventListener('click', reiniciarQuiz, false);

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      document.getElementById('waitMsg').style.display = "block";
      document.getElementById('uploadMsg').textContent = "";
      const reader = new FileReader();
      reader.onload = function(event) {
        setTimeout(() => {
          const data = event.target.result;
          const workbook = XLSX.read(data, {type: 'binary'});
          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          const json = XLSX.utils.sheet_to_json(sheet, {defval: ""});
          questions = [];
          for (const row of json) {
            const opts = [
              row["Answer 1"] ?? "",
              row["Answer 2"] ?? "",
              row["Answer 3"] ?? "",
              row["Answer 4"] ?? ""
            ];
            let scores = [
              row["Score"] ?? 0,
              row["Score.1"] ?? 0,
              row["Score.2"] ?? 0,
              row["Score.3"] ?? 0
            ];
            let answer = scores.findIndex(x => x == 1 || x === "1");
            if (answer === -1) answer = 0;
            questions.push({
              question: row["Questions"],
              options: opts,
              answer
            });
          }
          if (questions.length === 0) {
            document.getElementById('uploadMsg').textContent = "No se han detectado preguntas válidas en el archivo.";
            document.getElementById('quizContainer').style.display = "none";
            document.getElementById('waitMsg').style.display = "none";
            document.getElementById('restartQuizBtn').style.display = "none";
          } else {
            shuffleArray(questions);
            document.getElementById('quizContainer').style.display = "";
            document.getElementById('uploader').style.display = "none";
            document.getElementById('restartQuizBtn').style.display = "";
            selectedAnswers = Array(questions.length).fill(null);
            current = 0;
            quizCompleted = false;
            document.getElementById('waitMsg').style.display = "none";
            renderQuiz();
          }
        }, 150);
      };
      reader.readAsBinaryString(file);
    }

    function reiniciarQuiz() {
      selectedAnswers = Array(questions.length).fill(null);
      current = 0;
      quizCompleted = false;
      shuffleArray(questions);
      renderQuiz();
    }

    function renderQuiz() {
      const container = document.getElementById('quizContainer');
      container.innerHTML = '';
      if (quizCompleted) {
        renderResult(container);
        return;
      }
      const q = questions[current];
      const qElem = document.createElement('div');
      qElem.className = 'question';
      qElem.textContent = `(${current + 1}/${questions.length}) ${q.question}`;
      container.appendChild(qElem);
      const optsElem = document.createElement('div');
      optsElem.className = 'options';
      q.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.textContent = opt;
        btn.disabled = selectedAnswers[current] !== null;
        if (selectedAnswers[current] !== null) {
          if (idx === selectedAnswers[current]) {
            btn.classList.add(idx === q.answer ? 'correct' : 'incorrect');
          }
          if (idx === q.answer && selectedAnswers[current] !== q.answer) {
            btn.classList.add('correct');
          }
        }
        btn.onclick = () => selectOption(idx);
        optsElem.appendChild(btn);
      });
      container.appendChild(optsElem);
      const navElem = document.createElement('div');
      navElem.className = 'nav-buttons';
      const prevBtn = document.createElement('button');
      prevBtn.className = 'nav-btn';
      prevBtn.textContent = 'Atrás';
      prevBtn.disabled = current === 0;
      prevBtn.onclick = () => changeQuestion(-1);
      const nextBtn = document.createElement('button');
      nextBtn.className = 'nav-btn';
      nextBtn.textContent = current === questions.length - 1 ? 'Finalizar' : 'Siguiente';
      nextBtn.disabled = selectedAnswers[current] === null;
      nextBtn.onclick = () => {
        if (current === questions.length - 1) {
          quizCompleted = true;
          renderQuiz();
        } else {
          changeQuestion(1);
        }
      };
      navElem.appendChild(prevBtn);
      navElem.appendChild(nextBtn);
      container.appendChild(navElem);
    }
    function selectOption(idx) {
      if (selectedAnswers[current] === null) {
        selectedAnswers[current] = idx;
        renderQuiz();
      }
    }
    function changeQuestion(delta) {
      current += delta;
      renderQuiz();
    }
    function renderResult(container) {
      const correct = selectedAnswers.reduce((acc, ans, i) => acc + (ans === questions[i].answer ? 1 : 0), 0);
      const percent = Math.round((correct / questions.length) * 100);
      const resultElem = document.createElement('div');
      resultElem.className = 'result';
      resultElem.textContent = `Has acertado ${correct} de ${questions.length} preguntas (${percent}%)`;
      container.appendChild(resultElem);
      const restartBtn = document.createElement('button');
      restartBtn.className = 'restart-btn';
      restartBtn.textContent = 'Volver a empezar el quiz';
      restartBtn.onclick = reiniciarQuiz;
      container.appendChild(restartBtn);
    }
  </script>
</body>
</html>
